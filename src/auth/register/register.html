<app-navbar [role]="role"></app-navbar>

<div class="register-page">
  <div class="register-container">

    <h2>Gestione Utenti</h2>

    @if (successMessage) {
      <div class="alert alert-success">{{ successMessage }}</div>
    }

    @if (errorMessage) {
      <div class="alert alert-danger">{{ errorMessage }}</div>
    }

    <div class="forms-wrapper">
      <!-- ===== FORM: Registrazione Nuovo Utente ===== -->
      <section class="form-card">
        <h3>Registrazione Nuovo Utente</h3>
        <form [formGroup]="registerForm" (ngSubmit)="onRegister()">
          <div>
            <label for="nome">Nome:</label>
            <input id="nome" type="text" formControlName="name" placeholder="Mario">
            @if (registerForm.get('name')?.invalid && (registerForm.get('name')?.dirty || registerForm.get('name')?.touched)) {
              <div><small>Il nome è obbligatorio.</small></div>
            }
          </div>

          <div>
            <label for="cognome">Cognome:</label>
            <input id="cognome" type="text" formControlName="surname" placeholder="Rossi">
            @if (registerForm.get('surname')?.invalid && (registerForm.get('surname')?.dirty || registerForm.get('surname')?.touched)) {
              <div><small>Il cognome è obbligatorio.</small></div>
            }
          </div>

          <div>
            <label for="email">Email:</label>
            <input id="email" type="email" formControlName="email" placeholder="mario.rossi@email.com">
            @if (registerForm.get('email')?.invalid && (registerForm.get('email')?.dirty || registerForm.get('email')?.touched)) {
              <div>
                @if (registerForm.get('email')?.errors?.['required']) {
                  <small>L'email è obbligatoria.</small>
                }
                @if (registerForm.get('email')?.errors?.['email']) {
                  <small>Inserisci un'email valida.</small>
                }
              </div>
            }
          </div>

          <div>
            <label for="password">Password:</label>
            <input id="password" type="password" formControlName="password" placeholder="********">
            @if (registerForm.get('password')?.invalid && (registerForm.get('password')?.dirty || registerForm.get('password')?.touched)) {
              <div>
                @if (registerForm.get('password')?.errors?.['required']) {
                  <small>La password è obbligatoria.</small><br>
                }
                @if (registerForm.get('password')?.errors?.['minlength']) {
                  <small>Minimo 8 caratteri.</small><br>
                }
                @if (registerForm.get('password')?.errors?.['pattern']) {
                  <small>Deve contenere almeno una maiuscola, una minuscola, un numero e un carattere speciale.</small>
                }
              </div>
            }
          </div>

          <div>
            <label for="ruolo">Ruolo:</label>
            <select id="ruolo" formControlName="role">
              <option value="" disabled selected>Seleziona un ruolo</option>
              <option value="STANDARD">Utente</option>
              <option value="SUPERUSER">Supervisore</option>
              <option value="ADMIN">Admin</option>
            </select>
            @if (registerForm.get('role')?.invalid && (registerForm.get('role')?.dirty || registerForm.get('role')?.touched)) {
              <div><small>Il ruolo è obbligatorio.</small></div>
            }
          </div>

          <button type="submit" [disabled]="isRegistering || registerForm.invalid">
            {{ isRegistering ? 'Registrazione in corso...' : 'Registrati' }}
          </button>
        </form>
      </section>

      <!-- ===== FORM: Modifica Utente Esistente ===== -->
      <section class="form-card">
        <h3>Modifica Utente</h3>

        <div class="search-bar">
          <label for="searchEmail">Cerca per email:</label>
          <input id="searchEmail" type="email" [(ngModel)]="searchEmail" placeholder="inserisci email e premi Cerca">
          <button (click)="findUserByEmail()" [disabled]="!searchEmail">Cerca</button>
        </div>

        @if (editingUser) {
          <form [formGroup]="editForm" (ngSubmit)="onEditSave()">
            <div>
              <label for="editNome">Nome:</label>
              <input id="editNome" type="text" formControlName="name">
            </div>

            <div>
              <label for="editCognome">Cognome:</label>
              <input id="editCognome" type="text" formControlName="surname">
            </div>

            <div>
              <label for="editEmail">Email:</label>
              <input id="editEmail" type="email" formControlName="email">
            </div>

            <div>
              <label for="editPassword">Password:</label>
              <input id="editPassword" type="password" formControlName="password" placeholder="Nuova password se vuoi cambiarla">
            </div>

            <div>
              <label for="editRuolo">Ruolo:</label>
              <select id="editRuolo" formControlName="role">
                <option value="STANDARD">Utente</option>
                <option value="SUPERUSER">Supervisore</option>
                <option value="ADMIN">Admin</option>
              </select>
            </div>

            <button type="submit" [disabled]="isSavingEdit">Salva modifiche</button>
            <button type="button" (click)="cancelEdit()">Annulla</button>
          </form>
        } @else {
          <div class="no-user">Nessun utente selezionato. Cerca un'email per caricare l'utente.</div>
        }
      </section>
    </div>
    <!-- ===== LISTA UTENTI (solo Admin) ===== -->
    @if (role === 'ADMIN') {
      <section class="user-list-card">
        <h3>Lista Utenti</h3>

        <div class="user-list">
          @if (isLoadingUsers) {
            <p>Caricamento utenti...</p>
          } @else if (loadUsersError) {
            <p class="error-text">{{ loadUsersError }}</p>
          } @else if (usersList.length === 0) {
            <p>Nessun utente trovato.</p>
          } @else {
            @for (u of usersList; track u.email) {
              <div class="user-item">
                <p><strong>{{ u.name }} {{ u.surname }}</strong> — {{ u.email }}</p>
                <span class="role-tag">{{ u.role }}</span>
              </div>
            }
          }
        </div>
      </section>
    }
  </div>
</div>
